{% extends "base.html" %}

{% block content %}
<div class="notice-tabs">
    <a href="{{ url_for('attendance_notice') }}" class="tab-item active">출결 공지</a>
    <a href="{{ url_for('satisfaction_notice') }}" class="tab-item">만족도 공지</a>
    <a href="{{ url_for('thread_notice') }}" class="tab-item">운영 질문 스레드</a>
    <a href="{{ url_for('manage_notice') }}" class="tab-item">공지 관리</a>
    <a href="{{ url_for('notice_calendar') }}" class="tab-item">공지 캘린더</a>
</div>

<h1>출결 공지 예약</h1>

<form method="POST" class="workspace-form">
    <div class="form-group">
        <label><strong>공지 시간을 선택해주세요:</strong></label>
        <div class="radio-group">
            <label class="radio-container">
                입실
                <input type="radio" name="survey_type" value="입실" checked required>
                <span class="checkmark"></span>
            </label>

            <label class="radio-container">
                중간
                <input type="radio" name="survey_type" value="중간">
                <span class="checkmark"></span>
            </label>

            <label class="radio-container">
                퇴실
                <input type="radio" name="survey_type" value="퇴실">
                <span class="checkmark"></span>
            </label>
        </div>
    </div>

    <div class="form-group" id="additional-message-container">
        <label for="additional-message">추가 메시지:</label>
        <textarea name="additional_message" id="additional-message" 
                  class="additional-message-input" 
                  placeholder="추가로 전달할 메시지를 입력하세요"></textarea>
    </div>

    <div class="form-group">
        <label for="reservation">예약 날짜 (선택한 모든 날짜에 공지가 전송됩니다.):</label>
        <div class="date-input-wrapper">
            <input type="text" 
                   name="reservation" 
                   id="attendance-reservation" 
                   class="datepicker" 
                   required 
                   readonly
                   placeholder="날짜를 선택해주세요">
        </div>
    </div>

    <div class="form-group">
        <label style="display: flex; align-items: center; white-space: nowrap;">
            <input type="checkbox" id="no-image-checkbox" name="no_image" 
                   style="margin-right: 8px; width: 14px; height: 14px; padding: 0;">
            <span>QR 이미지 미첨부</span>
        </label>
    </div>

    <div class="form-group" style="margin-top: 20px;">
        <button type="submit" class="reservation_submit-btn">예약하기</button>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Flatpickr 설정
    const datePicker = flatpickr("#attendance-reservation", {
        mode: "multiple",
        dateFormat: "Y-m-d",
        minDate: "today",
        locale: "ko",
        conjunction: ", ",
        disable: [
            function(date) {
                // 워크스페이스 이름 가져오기
                const workspaceName = "{{ workspace_name }}";
                
                // 월~토 운영하는 워크스페이스 목록
                const monToSatWorkspaces = [
                    "테스트 1"
                ];
                
                if (monToSatWorkspaces.includes(workspaceName)) {
                    // 일요일(0)만 비활성화
                    return date.getDay() === 0;
                } else {
                    // 다른 워크스페이스는 토요일(6)과 일요일(0) 비활성화
                    return date.getDay() === 0 || date.getDay() === 6;
                }
            }
        ]
    });

    // 폼 제출 처리
    document.querySelector('form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const dates = datePicker.selectedDates;
        
        // 날짜 선택 확인
        if (dates.length === 0) {
            alert('날짜를 선택해주세요.');
            return;
        }

        const surveyType = document.querySelector('input[name="survey_type"]:checked').value;
        const additionalMessage = document.getElementById('additional-message').value;
        const noImage = document.getElementById('no-image-checkbox').checked;

        // 각 선택된 날짜에 대해 요청 보내기
        const promises = dates.map(date => {
            // 날짜를 YYYY-MM-DD 형식으로 변환하되, 시간대 고려
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;

            const formData = new FormData();
            formData.append('survey_type', surveyType);
            formData.append('reservation', formattedDate);  // 포맷된 날짜 사용
            formData.append('additional_message', additionalMessage);
            if (noImage) formData.append('no_image', 'on');

            return fetch('/notices/attendance', {
                method: 'POST',
                body: formData
            });
        });

        Promise.all(promises)
            .then(() => {
                alert('모든 공지가 성공적으로 예약되었습니다!');
                window.location.reload();
            })
            .catch(error => {
                alert('일부 공지 예약에 실패했습니다.');
                console.error('Error:', error);
            });
    });
});
</script>

<!-- Flatpickr CSS와 JS 추가 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_red.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
{% endblock %}